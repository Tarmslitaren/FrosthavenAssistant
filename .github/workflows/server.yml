name: CI

on:
  - push

jobs:
  container:
    name: Build docker container
    runs-on: ubuntu-latest
    env:
      DOCKER_TAG: >
        ${{
          github.ref == 'refs/heads/main' && 'latest' ||
          github.ref == 'refs/heads/container' && 'testing' ||
          'branch'
        }}
    defaults:
      run:
        working-directory: ./frosthaven_assistant_server
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Login to GitHub Container Registry
        run: docker login ghcr.io -u ${GITHUB_ACTOR} -p "${{ secrets.GITHUB_TOKEN }}"
      - name: Set DOCKER_TAG for tags
        if: startsWith(github.ref, 'refs/tags')
        run: |
          export DOCKER_TAG=$(echo "${{ github.ref }}" | sed 's/^refs\/tags\/v//g')
          echo "DOCKER_TAG=$DOCKER_TAG" >> "$GITHUB_ENV"
      - name: Build docker container
        run: docker build -t ghcr.io/${GITHUB_REPOSITORY}/server:$DOCKER_TAG .
      - name: Publish docker container
        if: vars.DOCKER_TAG != 'branch'
        run: docker push ghcr.io/${GITHUB_REPOSITORY}/server:$DOCKER_TAG
